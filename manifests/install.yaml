apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-o11y-server
spec:
  selector:
    matchLabels:
      app: argocd-o11y-server
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: argocd-o11y-server
    spec:
      containers:
        - env:
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: WAVEFRONT_ADDRESS
            value: https://intuit.wavefront.com/
          - name: WAVEFRONT_TOKEN
            value: ""
          image: sarabala1979/argo-o11y-server:v8
          imagePullPolicy: IfNotPresent
          name: argocd-o11y-server
          volumeMounts:
          - name: config-volume
            mountPath: /app/config.json
            subPath: config.json
      volumes:
      - name: config-volume
        configMap:
          name: argocd-o11y-server-configmap
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: argocd-o11y-server
  name: argocd-o11y-server
spec:
  ports:
    - name: metrics
      port: 9003
      targetPort: 9003
  selector:
    app: argocd-o11y-server
---
apiVersion: v1
data:
 config.json: |
  {
  "prometheus": {
    "applications": [
      {
        "name": "test",
        "default": true,
        "dashboards": [
          {
            "groupKind": "pod",
            "rows": [
              {
                "name": "container",
                "title": "Containers",
                "graphs": [
                  {
                    "name": "container_cpu_line",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_cpu_pie",
                    "title": "CPU Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\",container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_memory_line",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_memory_pie",
                    "title": "Mem Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  }
                ]
              },
              {
                "name": "pod",
                "title": "Pods",
                "graphs": [
                  {
                    "name": "pod_cpu_line",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_cpu_pie",
                    "title": "CPU Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_memory_line",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_memory_pie",
                    "title": "Mem Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  }
                ]
              }
            ]
          },
          {
            "groupKind": "replicaset",
            "rows": [
              {
                "name": "container",
                "title": "Containers",
                "graphs": [
                  {
                    "name": "container_cpu_line",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_cpu_pie",
                    "title": "CPU Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\",container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_memory_line",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_memory_pie",
                    "title": "Mem Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  }
                ]
              },
              {
                "name": "pod",
                "title": "Pods",
                "graphs": [
                  {
                    "name": "pod_cpu_line",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_cpu_pie",
                    "title": "CPU Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_memory_line",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_memory_pie",
                    "title": "Mem Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  }
                ]
              }
            ]
          },
          {
            "groupKind": "rollout",
            "rows": [
              {
                "name": "container",
                "title": "Containers",
                "graphs": [
                  {
                    "name": "container_cpu_line",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_cpu_pie",
                    "title": "CPU Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\",container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_memory_line",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_memory_pie",
                    "title": "Mem Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  }
                ]
              },
              {
                "name": "pod",
                "title": "Pods",
                "graphs": [
                  {
                    "name": "pod_cpu_line",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_cpu_pie",
                    "title": "CPU Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_memory_line",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_memory_pie",
                    "title": "Mem Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  }
                ]
              }
            ]
          },
          {
            "groupKind": "deployment",
            "rows": [
              {
                "name": "httperrorcount",
                "title": "HTTP Error Count",
                "graphs": [
                  {
                    "name": "http_error_count",
                    "title": "Error",
                    "description": "",
                    "graphType": "line",
                    "metricName": "namespace",
                    "queryExpression": "sum(rate(namespace_app_pod_http_server_requests_errors {namespace = \"{{.namespace}}\" }[1m])) by (namespace)"
                  },
                  {
                    "name": "http_error_anomaly_score",
                    "title": "Error Anomaly",
                    "description": "",
                    "graphType": "line",
                    "metricName": "namespace",
                    "queryExpression": "sum(rate(namespace_app_pod_error_count_anomaly {namespace = \"{{.namespace}}\" }[1m])) by (namespace)"
                  }
                ]
              },
              {
                "name": "httperrorrate",
                "title": "HTTP Error Rate",
                "graphs": [
                  {
                    "name": "http_error_rate",
                    "title": "Error Rate",
                    "description": "",
                    "graphType": "line",
                    "metricName": "namespace",
                    "queryExpression": "sum(rate(namespace_app_pod_http_server_requests_error_rate {namespace = \"{{.namespace}}\" }[1m])) by (namespace)"
                  },
                  {
                    "name": "http_error_rate_anomaly_score",
                    "title": "Error Rate Anomaly",
                    "description": "",
                    "graphType": "line",
                    "metricName": "namespace",
                    "queryExpression": "sum(rate(namespace_app_pod_error_rate_anomaly {namespace = \"{{.namespace}}\" }[1m])) by (namespace)"
                  }
                ]
              },
              {
                "name": "httplatency",
                "title": "HTTP Latency",
                "graphs": [
                  {
                    "name": "http_latency",
                    "title": "Latency",
                    "description": "",
                    "graphType": "line",
                    "metricName": "namespace",
                    "queryExpression": "sum(rate(namespace_app_pod_http_server_requests_latency {namespace = \"{{.namespace}}\" }[1m])) by (namespace)"
                  },
                  {
                    "name": "http_latency_anomaly_score",
                    "title": "Latency Anomaly",
                    "description": "",
                    "graphType": "line",
                    "metricName": "namespace",
                    "queryExpression": "sum(rate(namespace_app_pod_latency_anomaly {namespace = \"{{.namespace}}\" }[1m])) by (namespace)"
                  }
                ]
              },
              {
                "name": "cpuanomalyscore",
                "title": "CPU Anomaly Score",
                "graphs": [
                  {
                    "name": "cpu_utilization",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "namespace",
                    "queryExpression": "sum(rate(namespace_asset_pod_cpu_utilization {namespace = \"{{.namespace}}\" }[1m])) by (namespace)"
                  },
                  {
                    "name": "cpu_anomaly_score",
                    "title": "CPU Anomaly",
                    "description": "",
                    "graphType": "line",
                    "metricName": "namespace",
                    "queryExpression": "sum(rate(namespace_app_pod_cpu_anomaly {namespace = \"{{.namespace}}\" }[1m])) by (namespace)"
                  }
                ]
              },
              {
                "name": "memanomalyscore",
                "title": "Memory Anomaly Score",
                "graphs": [
                  {
                    "name": "mem_utilization",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "namespace",
                    "queryExpression": "sum(rate(namespace_asset_pod_memory_utilization {namespace = \"{{.namespace}}\" }[1m])) by (namespace)"
                  },
                  {
                    "name": "c_anomaly_score",
                    "title": "Memory Anomaly",
                    "description": "",
                    "graphType": "line",
                    "metricName": "namespace",
                    "queryExpression": "sum(rate(namespace_app_pod_cpu_anomaly {namespace = \"{{.namespace}}\" }[1m])) by (namespace)"
                  }
                ]
              },
              {
                "name": "container",
                "title": "Containers",
                "graphs": [
                  {
                    "name": "container_cpu_line",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_cpu_pie",
                    "title": "CPU Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\",container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_memory_line",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_memory_pie",
                    "title": "Mem Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  }
                ]
              },
              {
                "name": "pod",
                "title": "Pods",
                "graphs": [
                  {
                    "name": "pod_cpu_line",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_cpu_pie",
                    "title": "CPU Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_memory_line",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_memory_pie",
                    "title": "Mem Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  }
                ]
              }
            ]
          },
          {
            "groupKind": "application",
            "rows": [
              {
                "name": "container",
                "title": "Containers",
                "graphs": [
                  {
                    "name": "container_cpu_line",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_cpu_pie",
                    "title": "CPU Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\",container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_memory_line",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  },
                  {
                    "name": "container_memory_pie",
                    "title": "Mem Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "container",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (container)"
                  }
                ]
              },
              {
                "name": "pod",
                "title": "Pods",
                "graphs": [
                  {
                    "name": "pod_cpu_line",
                    "title": "CPU",
                    "description": "",
                    "graphType": "line",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", image!=\"\", container!=\"POD\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_cpu_pie",
                    "title": "CPU Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_cpu_usage_seconds_total{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_memory_line",
                    "title": "Memory",
                    "description": "",
                    "graphType": "line",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  },
                  {
                    "name": "pod_memory_pie",
                    "title": "Mem Avg",
                    "description": "",
                    "graphType": "pie",
                    "metricName": "pod",
                    "queryExpression": "sum(rate(container_memory_usage_bytes{pod=~\"{{.name}}\", container!=\"POD\", image!=\"\", container!=\"\", container_name!=\"POD\"}[5m])) by (pod)"
                  }
                ]
              }
            ]
          }
        ]
      }
    ],
    "provider":
    {
      "Name": "default",
      "default": true,
      "address": "http://prometheus-service.monitoring.svc.cluster.local:8080"
    }
  }
  }
kind: ConfigMap
metadata:
 labels:
  app.kubernetes.io/instance: metric-server
 name: argocd-o11y-server-configmap
 namespace: argocd
